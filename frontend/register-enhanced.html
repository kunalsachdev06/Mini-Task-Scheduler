<!doctype html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Register - Task Scheduler | Secure Sign Up</title>
  <meta name="description" content="Create your secure Task Scheduler account with 3-factor authentication">
  
  <!-- Enhanced Styles -->
  <link rel="stylesheet" href="styles-enhanced.css">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  
  <!-- Mobile optimizations -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Task Scheduler">
  <link rel="apple-touch-icon" href="./assets/logo.png">
  
  <!-- Theme colors -->
  <meta name="theme-color" content="#2563eb">
  <meta name="msapplication-TileColor" content="#2563eb">
  
  <!-- Face Recognition Library -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  
  <style>
    /* Registration-specific styles */
    .register-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
      position: relative;
    }
    
    .dark .register-container {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    .register-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%232563eb" fill-opacity="0.05"><circle cx="30" cy="30" r="2"/></g></svg>') repeat;
      pointer-events: none;
    }
    
    .register-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-2xl);
      padding: var(--space-12);
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 100%;
      border: 1px solid var(--border-color);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(20px);
    }
    
    .register-header {
      text-align: center;
      margin-bottom: var(--space-12);
    }
    
    .logo-container {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      border-radius: var(--radius-2xl);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-lg);
    }
    
    .logo-container img {
      width: 50px;
      height: 50px;
      filter: brightness(0) invert(1);
    }
    
    .register-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: var(--space-3);
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .register-subtitle {
      color: var(--text-secondary);
      font-size: 1.125rem;
      margin-bottom: var(--space-2);
    }
    
    .security-badges {
      display: flex;
      justify-content: center;
      gap: var(--space-4);
      margin-top: var(--space-4);
    }
    
    .security-badge {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--success-500);
      color: white;
      border-radius: var(--radius-xl);
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .form-section {
      margin-bottom: var(--space-8);
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--space-6);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .step-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--primary-500);
      color: white;
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.875rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    
    .form-group-full {
      grid-column: 1 / -1;
    }
    
    .password-strength {
      margin-top: var(--space-2);
    }
    
    .strength-bar {
      height: 4px;
      border-radius: var(--radius-sm);
      background: var(--border-color);
      overflow: hidden;
      margin-bottom: var(--space-2);
    }
    
    .strength-fill {
      height: 100%;
      transition: all var(--transition-normal);
      border-radius: var(--radius-sm);
    }
    
    .strength-weak .strength-fill {
      width: 25%;
      background: var(--danger-500);
    }
    
    .strength-fair .strength-fill {
      width: 50%;
      background: var(--warning-500);
    }
    
    .strength-good .strength-fill {
      width: 75%;
      background: var(--primary-500);
    }
    
    .strength-strong .strength-fill {
      width: 100%;
      background: var(--success-500);
    }
    
    .strength-text {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .requirements-list {
      list-style: none;
      margin-top: var(--space-3);
    }
    
    .requirements-list li {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: var(--space-1);
    }
    
    .requirements-list li.valid {
      color: var(--success-500);
    }
    
    .requirements-list li .icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
    }
    
    .requirements-list li.valid .icon {
      background: var(--success-500);
    }
    
    .camera-section {
      background: var(--bg-tertiary);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      text-align: center;
      border: 2px dashed var(--border-color);
      transition: all var(--transition-normal);
    }
    
    .camera-section.active {
      border-color: var(--primary-500);
      background: var(--primary-50);
    }
    
    .dark .camera-section.active {
      background: var(--primary-900);
    }
    
    .camera-icon {
      width: 60px;
      height: 60px;
      background: var(--primary-500);
      border-radius: var(--radius-xl);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--space-4);
      font-size: 1.5rem;
      color: white;
    }
    
    #videoElement {
      width: 100%;
      max-width: 300px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin: var(--space-4) 0;
    }
    
    .otp-section {
      background: var(--bg-tertiary);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      text-align: center;
    }
    
    .otp-inputs {
      display: flex;
      gap: var(--space-3);
      justify-content: center;
      margin: var(--space-6) 0;
    }
    
    .otp-input {
      width: 60px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-secondary);
      transition: all var(--transition-fast);
    }
    
    .otp-input:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .success-checkmark {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--success-500);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: var(--space-2);
    }
    
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger-600);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      margin-top: var(--space-3);
      font-size: 0.875rem;
    }
    
    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success-600);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      margin-top: var(--space-3);
      font-size: 0.875rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-bottom: var(--space-8);
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
      transition: width var(--transition-normal);
      border-radius: var(--radius-sm);
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      margin-bottom: var(--space-6);
      transition: color var(--transition-fast);
    }
    
    .back-link:hover {
      color: var(--primary-600);
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .register-card {
        padding: var(--space-8);
        margin: var(--space-4);
      }
      
      .register-title {
        font-size: 1.75rem;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .security-badges {
        flex-direction: column;
        align-items: center;
      }
      
      .otp-inputs {
        gap: var(--space-2);
      }
      
      .otp-input {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
      }
    }
    
    @media (max-width: 480px) {
      .register-container {
        padding: var(--space-2);
      }
      
      .register-card {
        padding: var(--space-6);
      }
      
      .logo-container {
        width: 60px;
        height: 60px;
      }
      
      .logo-container img {
        width: 35px;
        height: 35px;
      }
    }
  </style>
</head>
<body>
  <div class="register-container">
    <div class="register-card animate-fade-in">
      <!-- Back Navigation -->
      <a href="index.html" class="back-link">
        ← Back to Home
      </a>
      
      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <!-- Header -->
      <div class="register-header">
        <div class="logo-container">
          <img src="./assets/logo.png" alt="Task Scheduler Logo">
        </div>
        <h1 class="register-title">Create Your Account</h1>
        <p class="register-subtitle">Join the future of productivity with secure 3-factor authentication</p>
        <div class="security-badges">
          <div class="security-badge">
            🛡️ 256-bit Encryption
          </div>
          <div class="security-badge">
            📱 SMS Verification
          </div>
          <div class="security-badge">
            👤 Face Recognition
          </div>
        </div>
      </div>

      <!-- Registration Form -->
      <form id="registrationForm">
        <!-- Step 1: Basic Information -->
        <div class="form-section" id="step1">
          <h2 class="section-title">
            <span class="step-indicator">1</span>
            Basic Information
          </h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" id="firstName" name="firstName" class="form-input" placeholder="John" required>
            </div>
            <div class="form-group">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" id="lastName" name="lastName" class="form-input" placeholder="Doe" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="username" class="form-label">Username</label>
              <input type="text" id="username" name="username" class="form-input" placeholder="johndoe123" required>
            </div>
            <div class="form-group">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" id="email" name="email" class="form-input" placeholder="john@example.com" required>
            </div>
          </div>
          
          <div class="form-group-full">
            <label for="mobile" class="form-label">Mobile Number</label>
            <input type="tel" id="mobile" name="mobile" class="form-input" placeholder="+1 (555) 123-4567" required>
          </div>
          
          <div class="form-group-full">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" name="password" class="form-input" placeholder="Create a strong password" required>
            
            <div class="password-strength">
              <div class="strength-bar">
                <div class="strength-fill" id="strengthFill"></div>
              </div>
              <div class="strength-text" id="strengthText">Password strength will appear here</div>
              
              <ul class="requirements-list">
                <li id="req-length">
                  <span class="icon">✓</span>
                  At least 8 characters
                </li>
                <li id="req-upper">
                  <span class="icon">✓</span>
                  One uppercase letter
                </li>
                <li id="req-lower">
                  <span class="icon">✓</span>
                  One lowercase letter
                </li>
                <li id="req-number">
                  <span class="icon">✓</span>
                  One number
                </li>
                <li id="req-special">
                  <span class="icon">✓</span>
                  One special character
                </li>
              </ul>
            </div>
          </div>
          
          <div class="form-group-full">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="Confirm your password" required>
          </div>
          
          <button type="button" id="step1Next" class="btn btn-primary btn-lg w-full">
            Continue to Mobile Setup
          </button>
        </div>
        
        <!-- Step 2: Mobile Verification -->
        <div class="form-section register-step-hidden" id="step2">
          <h2 class="section-title">
            <span class="step-indicator">2</span>
            Mobile Verification
          </h2>
          
          <div class="otp-section">
            <div class="camera-icon">📱</div>
            <h3>Verify Your Mobile Number</h3>
            <p>We've sent a verification code to <strong id="mobileDisplay"></strong></p>
            
            <div class="otp-inputs">
              <input type="text" class="otp-input" maxlength="1" inputmode="numeric">
              <input type="text" class="otp-input" maxlength="1" inputmode="numeric">
              <input type="text" class="otp-input" maxlength="1" inputmode="numeric">
              <input type="text" class="otp-input" maxlength="1" inputmode="numeric">
              <input type="text" class="otp-input" maxlength="1" inputmode="numeric">
              <input type="text" class="otp-input" maxlength="1" inputmode="numeric">
            </div>
            
            <p>Didn't receive the code? <a href="#" id="resendOTP" class="register-resend-link">Resend</a></p>
          </div>
          
          <div class="register-button-container">
            <button type="button" id="step2Back" class="btn btn-secondary register-btn-back">
              ← Back
            </button>
            <button type="button" id="step2Next" class="btn btn-primary register-btn-continue">
              Continue to Face Setup
            </button>
          </div>
        </div>
        
        <!-- Step 3: Face Recognition Setup -->
        <div class="form-section register-step-hidden" id="step3">
          <h2 class="section-title">
            <span class="step-indicator">3</span>
            Face Recognition Setup
          </h2>
          
          <div class="camera-section">
            <div class="camera-icon">📷</div>
            <h3>Set Up Face Recognition</h3>
            <p>Position your face within the frame and click capture when ready</p>
            
            <video id="videoElement" autoplay muted class="register-video-hidden"></video>
            <canvas id="canvasElement" class="register-canvas-hidden"></canvas>
            
            <div id="cameraControls" class="register-camera-controls">
              <button type="button" id="startCamera" class="btn btn-primary">
                Start Camera
              </button>
            </div>
            
            <div id="captureControls" class="register-capture-controls">
              <button type="button" id="capturePhoto" class="btn btn-success">
                📷 Capture Photo
              </button>
              <button type="button" id="retakePhoto" class="btn btn-secondary">
                🔄 Retake
              </button>
            </div>
          </div>
          
          <div class="register-button-container">
            <button type="button" id="step3Back" class="btn btn-secondary register-btn-back">
              ← Back
            </button>
            <button type="button" id="step3Next" class="btn btn-primary register-btn-continue" disabled>
              Complete Registration
            </button>
          </div>
        </div>
      </form>
      
      <!-- Messages -->
      <div id="errorMessage" class="error-message register-message-hidden"></div>
      <div id="successMessage" class="success-message register-message-hidden"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, RecaptchaVerifier, signInWithPhoneNumber } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAKSP427ylNW6ZAqZsZJ92CS549t76mSMk",
      authDomain: "mini-task-scheduler.firebaseapp.com",
      projectId: "mini-task-scheduler",
      storageBucket: "mini-task-scheduler.firebasestorage.app",
      messagingSenderId: "997330328846",
      appId: "1:997330328846:web:c217d6b5e4686f70298b5f",
      measurementId: "G-V0M473G51C"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    window.firebaseAuth = getAuth(app);
    window.firebaseDb = getFirestore(app);
    
    console.log('✅ Firebase initialized for registration');
  </script>
  
  <!-- Firebase reCAPTCHA Container -->
  <div id="recaptcha-container" style="display: none;"></div>

  <script>
    // Enhanced Registration System
    class RegistrationManager {
      constructor() {
        this.currentStep = 1;
        this.maxSteps = 3;
        this.registrationData = {};
        this.faceData = null;
        this.otpSent = false;
        this.confirmationResult = null; // Store Firebase phone confirmation
        this.recaptchaVerifier = null;
        this.firebaseUser = null; // Store Firebase user after creation
        
        // Wait for Firebase to initialize
        this.waitForFirebase().then(() => {
          this.initializeAuth();
          this.initializeEventListeners();
          this.initializeOTPInputs();
          this.initializePasswordValidation();
          this.initializeFaceRecognition();
          console.log('✅ Registration Manager initialized with Firebase');
        });
      }

      // Wait for Firebase to be ready
      async waitForFirebase() {
        let attempts = 0;
        while (!window.firebaseAuth && attempts < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }
        if (!window.firebaseAuth) {
          throw new Error('Firebase failed to initialize');
        }
      }

      // Initialize simple authentication system
      initializeAuth() {
        // Detect environment
        this.isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        this.apiBaseUrl = this.isDevelopment 
          ? 'http://localhost:3000/api'
          : 'https://task-scheduler-backend-production-c243.up.railway.app/api';
        
        console.log('🔐 Auth system initialized with API:', this.apiBaseUrl);
      }

      // Simple API call method
      async apiCall(endpoint, method = 'GET', data = null) {
        const config = {
          method,
          headers: {
            'Content-Type': 'application/json',
          },
        };

        if (data) {
          config.body = JSON.stringify(data);
        }

        try {
          const response = await fetch(`${this.apiBaseUrl}${endpoint}`, config);
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'API call failed');
          }
          
          return result;
        } catch (error) {
          console.error('API call failed:', error);
          // Return demo response for offline mode
          return { success: false, error: error.message, demo: true };
        }
      }

      // Send OTP (with demo fallback) - renamed to avoid conflict
      async sendOTPToBackend(mobile) {
        try {
          // Try backend first
          const response = await this.apiCall('/auth/send-otp', 'POST', { mobile });
          
          if (response.success) {
            return response;
          }
        } catch (error) {
          console.log('Backend OTP failed, using demo mode');
        }
        
        // Demo mode fallback
        const demoOTP = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('demoOTP', demoOTP);
        localStorage.setItem('demoOTPMobile', mobile);
        
        return { 
          success: true, 
          demo: true,
          otp: demoOTP,
          message: `Demo OTP sent to ${mobile}` 
        };
      }

      // Verify OTP with Firebase
      async verifyOTP(otp, mobile) {
        try {
          // Handle test phone number
          if (this.confirmationResult?.isTestPhone) {
            if (otp === '123456') {
              console.log('✅ Test phone OTP verified');
              
              // Create Firebase user with email/password
              const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
              const userCredential = await createUserWithEmailAndPassword(
                window.firebaseAuth,
                this.registrationData.email,
                this.registrationData.password
              );
              
              this.firebaseUser = userCredential.user;
              console.log('✅ Firebase user created:', this.firebaseUser.uid);
              
              return { success: true, message: 'Test OTP verified successfully' };
            } else {
              return { success: false, error: 'Invalid test OTP. Use: 123456' };
            }
          }
          
          // Verify real Firebase OTP
          if (!this.confirmationResult) {
            return { success: false, error: 'No OTP sent. Please request OTP first.' };
          }
          
          const result = await this.confirmationResult.confirm(otp);
          this.firebaseUser = result.user;
          
          console.log('✅ Firebase phone OTP verified successfully');
          console.log('✅ Firebase user created:', this.firebaseUser.uid);
          
          // Link email/password to this phone account
          const { EmailAuthProvider, linkWithCredential } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          
          try {
            const credential = EmailAuthProvider.credential(
              this.registrationData.email,
              this.registrationData.password
            );
            await linkWithCredential(this.firebaseUser, credential);
            console.log('✅ Email linked to phone account');
          } catch (linkError) {
            console.warn('⚠️ Could not link email:', linkError.message);
            // Continue anyway - phone auth is successful
          }
          
          return { success: true, message: 'OTP verified successfully' };
          
        } catch (error) {
          console.error('❌ OTP verification failed:', error);
          
          if (error.code === 'auth/invalid-verification-code') {
            return { success: false, error: 'Invalid OTP code. Please try again.' };
          } else if (error.code === 'auth/code-expired') {
            return { success: false, error: 'OTP expired. Please request a new code.' };
          } else {
            return { success: false, error: error.message || 'OTP verification failed' };
          }
        }
      }
      
      initializeEventListeners() {
        // Step navigation
        document.getElementById('step1Next').addEventListener('click', () => this.handleStep1Next());
        document.getElementById('step2Back').addEventListener('click', () => this.goToStep(1));
        document.getElementById('step2Next').addEventListener('click', () => this.handleStep2Next());
        document.getElementById('step3Back').addEventListener('click', () => this.goToStep(2));
        document.getElementById('step3Next').addEventListener('click', () => this.handleStep3Next());
        
        // Camera controls
        document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
        document.getElementById('capturePhoto').addEventListener('click', () => this.capturePhoto());
        document.getElementById('retakePhoto').addEventListener('click', () => this.retakePhoto());
        
        // OTP resend
        document.getElementById('resendOTP').addEventListener('click', (e) => {
          e.preventDefault();
          this.resendOTP();
        });
      }
      
      initializeOTPInputs() {
        const otpInputs = document.querySelectorAll('.otp-input');
        
        otpInputs.forEach((input, index) => {
          input.addEventListener('input', (e) => {
            if (e.target.value.length === 1 && index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }
          });
          
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
              otpInputs[index - 1].focus();
            }
          });
        });
      }
      
      initializePasswordValidation() {
        const passwordInput = document.getElementById('password');
        passwordInput.addEventListener('input', () => this.validatePassword());
      }
      
      validatePassword() {
        const password = document.getElementById('password').value;
        const strengthBar = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        
        const requirements = {
          length: password.length >= 8,
          upper: /[A-Z]/.test(password),
          lower: /[a-z]/.test(password),
          number: /\d/.test(password),
          special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Update requirement indicators
        Object.keys(requirements).forEach(req => {
          const element = document.getElementById(`req-${req}`);
          if (requirements[req]) {
            element.classList.add('valid');
          } else {
            element.classList.remove('valid');
          }
        });
        
        // Calculate strength
        const validCount = Object.values(requirements).filter(Boolean).length;
        let strength = 'weak';
        
        if (validCount >= 5) strength = 'strong';
        else if (validCount >= 4) strength = 'good';
        else if (validCount >= 2) strength = 'fair';
        
        // Update UI
        strengthBar.parentElement.className = `strength-bar strength-${strength}`;
        strengthText.textContent = `Password strength: ${strength.toUpperCase()}`;
        strengthText.className = `strength-text text-${strength}`;
        
        return validCount >= 4; // Require at least 4 criteria
      }
      
      async handleStep1Next() {
        const button = document.getElementById('step1Next');
        
        if (!this.validateStep1()) return;
        
        // Show loading
        button.innerHTML = '<span class="loading-spinner"></span> Validating...';
        button.disabled = true;
        
        try {
          // Collect form data
          this.registrationData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            mobile: document.getElementById('mobile').value,
            password: document.getElementById('password').value
          };
          
          // Simulate server validation
          await this.delay(1000);
          
          // Send OTP
          await this.sendOTP();
          
          this.goToStep(2);
          
        } catch (error) {
          this.showError(error.message);
        } finally {
          button.innerHTML = 'Continue to Mobile Setup';
          button.disabled = false;
        }
      }
      
      validateStep1() {
        const fields = ['firstName', 'lastName', 'username', 'email', 'mobile', 'password', 'confirmPassword'];
        let isValid = true;
        
        // Clear previous errors
        this.hideMessages();
        
        // Check required fields
        for (const field of fields) {
          const input = document.getElementById(field);
          if (!input.value.trim()) {
            this.showError(`${field.replace(/([A-Z])/g, ' $1').toLowerCase()} is required`);
            input.focus();
            return false;
          }
        }
        
        // Validate email
        const email = document.getElementById('email').value;
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          this.showError('Please enter a valid email address');
          return false;
        }
        
        // Validate password strength
        if (!this.validatePassword()) {
          this.showError('Password does not meet security requirements');
          return false;
        }
        
        // Check password confirmation
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (password !== confirmPassword) {
          this.showError('Passwords do not match');
          return false;
        }
        
        return true;
      }
      
      async sendOTP() {
        try {
          // Display mobile number
          document.getElementById('mobileDisplay').textContent = this.registrationData.mobile;
          
          console.log('📱 Sending Firebase OTP to:', this.registrationData.mobile);
          
          // Initialize reCAPTCHA if not already done
          if (!this.recaptchaVerifier) {
            this.recaptchaVerifier = new window.firebase.auth.RecaptchaVerifier(
              window.firebaseAuth,
              'recaptcha-container',
              {
                'size': 'normal',
                'callback': (response) => {
                  console.log('✅ reCAPTCHA solved');
                },
                'expired-callback': () => {
                  console.warn('⚠️ reCAPTCHA expired');
                  this.recaptchaVerifier = null;
                }
              }
            );
            await this.recaptchaVerifier.render();
            document.getElementById('recaptcha-container').style.display = 'block';
          }
          
          // Check for test phone number
          const testPhone = '+919876543210';
          if (this.registrationData.mobile === testPhone) {
            console.log('🔧 Using test phone number - Demo OTP: 123456');
            
            // Show test OTP display
            const otpDisplay = document.createElement('div');
            otpDisplay.id = 'demo-otp-display';
            otpDisplay.style.cssText = `
              background: #fff3cd;
              border: 2px solid #ffc107;
              border-radius: 8px;
              padding: 15px;
              margin: 15px 0;
              text-align: center;
              font-family: monospace;
              font-size: 1.2rem;
              color: #856404;
              font-weight: bold;
            `;
            otpDisplay.innerHTML = `
              <div style="margin-bottom: 8px;">🔐 <strong>Test Phone OTP</strong></div>
              <div style="font-size: 2rem; letter-spacing: 4px; margin: 10px 0;">123456</div>
              <div style="font-size: 0.9rem; color: #666;">
                Test phone number detected. Use OTP: 123456
              </div>
            `;
            
            const step2 = document.getElementById('step2');
            const otpSection = step2.querySelector('.otp-section');
            if (otpSection && !document.getElementById('demo-otp-display')) {
              otpSection.appendChild(otpDisplay);
            }
            
            this.otpSent = true;
            this.confirmationResult = { isTestPhone: true }; // Mark as test
            this.showSuccess('✅ Test OTP generated! Use code: 123456');
            return;
          }
          
          // Send real Firebase OTP
          const appVerifier = this.recaptchaVerifier;
          const { signInWithPhoneNumber } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          
          this.confirmationResult = await signInWithPhoneNumber(
            window.firebaseAuth,
            this.registrationData.mobile,
            appVerifier
          );
          
          this.otpSent = true;
          this.showSuccess('✅ Verification code sent to your phone!');
          console.log('✅ Firebase OTP sent successfully');
          
        } catch (error) {
          console.error('❌ Error sending OTP:', error);
          
          // Handle specific Firebase errors
          if (error.code === 'auth/invalid-phone-number') {
            this.showError('Invalid phone number format. Use format: +1234567890');
          } else if (error.code === 'auth/too-many-requests') {
            this.showError('Too many requests. Please try again later or use test number: +919876543210');
          } else if (error.code === 'auth/captcha-check-failed') {
            this.showError('reCAPTCHA verification failed. Please refresh and try again.');
            this.recaptchaVerifier = null;
          } else {
            this.showError('Failed to send verification code: ' + error.message);
          }
          
          throw error;
        }
      }
      
      async handleStep2Next() {
        const button = document.getElementById('step2Next');
        
        if (!this.validateOTP()) return;
        
        button.innerHTML = '<span class="loading-spinner"></span> Verifying...';
        button.disabled = true;
        
        try {
          // Verify OTP using the new method
          const otpInputs = document.querySelectorAll('.otp-input');
          const otp = Array.from(otpInputs).map(input => input.value).join('');
          
          const result = await this.verifyOTP(otp, this.registrationData.mobile);
          
          if (result.success) {
            this.showSuccess('✅ OTP verified successfully!');
            await this.delay(1000);
            this.goToStep(3);
          } else {
            throw new Error(result.error || 'Invalid OTP');
          }
        } catch (error) {
          this.showError(error.message);
        } finally {
          button.innerHTML = 'Continue to Face Setup';
          button.disabled = false;
        }
      }
      
      validateOTP() {
        const otpInputs = document.querySelectorAll('.otp-input');
        const otp = Array.from(otpInputs).map(input => input.value).join('');
        
        if (otp.length !== 6) {
          this.showError('Please enter the complete 6-digit verification code');
          return false;
        }
        
        if (!/^\d{6}$/.test(otp)) {
          this.showError('Verification code must contain only numbers');
          return false;
        }
        
        return true; // Basic validation passed, actual verification happens in handleStep2Next
      }
      
      async initializeFaceRecognition() {
        try {
          // Load face-api models from CDN
          if (typeof faceapi !== 'undefined') {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            console.log('✅ Face recognition models loaded from CDN');
          } else {
            console.warn('⚠️ Face API library not loaded');
          }
        } catch (error) {
          console.warn('⚠️ Face recognition models failed to load, using demo mode:', error.message);
          // Continue without face recognition - will use demo mode
        }
      }
      
      async startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              width: 640, 
              height: 480,
              facingMode: 'user'
            } 
          });
          
          const video = document.getElementById('videoElement');
          video.srcObject = stream;
          video.style.display = 'block';
          
          document.getElementById('cameraControls').style.display = 'none';
          document.getElementById('captureControls').style.display = 'block';
          
          document.querySelector('.camera-section').classList.add('active');
          
          this.showSuccess('Camera started! Position your face and click capture.');
          
        } catch (error) {
          console.error('Camera error:', error);
          
          // Provide different error messages based on the error type
          if (error.name === 'NotAllowedError') {
            this.showError('Camera access denied. Please allow camera access and try again.');
          } else if (error.name === 'NotFoundError') {
            this.showError('No camera found. You can continue with demo mode.');
            this.enableDemoMode();
          } else {
            this.showError('Camera not available. Continuing with demo mode.');
            this.enableDemoMode();
          }
        }
      }
      
      enableDemoMode() {
        // Hide camera controls
        document.getElementById('cameraControls').style.display = 'none';
        
        // Show demo mode button
        const demoButton = document.createElement('button');
        demoButton.type = 'button';
        demoButton.className = 'btn btn-secondary';
        demoButton.textContent = 'Continue with Demo Mode';
        demoButton.onclick = () => this.capturePhotoDemo();
        
        const cameraSection = document.querySelector('.camera-section');
        cameraSection.appendChild(demoButton);
        
        this.showSuccess('Demo mode enabled. Click continue to proceed.');
      }
      
      capturePhotoDemo() {
        // Generate a demo face data
        this.faceData = 'data:image/jpeg;base64,demo_face_data_' + Date.now();
        
        // Show success and enable next button
        this.showSuccess('Demo face data captured successfully!');
        document.getElementById('step3Next').disabled = false;
        
        // Hide demo button
        const demoButton = document.querySelector('.camera-section button');
        if (demoButton) demoButton.style.display = 'none';
        
        // Show demo confirmation
        const demoInfo = document.createElement('div');
        demoInfo.style.cssText = 'background: var(--success-bg); color: var(--success-color); padding: var(--space-4); border-radius: var(--radius-lg); margin-top: var(--space-4);';
        demoInfo.innerHTML = '✅ Demo mode: Face recognition data simulated';
        document.querySelector('.camera-section').appendChild(demoInfo);
      }
      
      capturePhoto() {
        try {
          const video = document.getElementById('videoElement');
          const canvas = document.getElementById('canvasElement');
          
          if (!video.srcObject) {
            this.showError('Camera not active. Please restart camera.');
            return;
          }
          
          const ctx = canvas.getContext('2d');
          
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          
          // Convert to base64
          this.faceData = canvas.toDataURL('image/jpeg', 0.8);
          
          // Stop camera
          const stream = video.srcObject;
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          video.style.display = 'none';
          document.getElementById('captureControls').style.display = 'none';
          
          // Show success and enable next button
          this.showSuccess('Face photo captured successfully!');
          document.getElementById('step3Next').disabled = false;
          
          // Show preview
          const preview = document.createElement('img');
          preview.src = this.faceData;
          preview.style.cssText = 'width: 200px; border-radius: var(--radius-lg); margin-top: var(--space-4); border: 2px solid var(--success-color);';
          
          const cameraSection = document.querySelector('.camera-section');
          cameraSection.appendChild(preview);
          
          // Add retake button
          const retakeBtn = document.createElement('button');
          retakeBtn.type = 'button';
          retakeBtn.className = 'btn btn-secondary';
          retakeBtn.textContent = 'Retake Photo';
          retakeBtn.style.marginTop = 'var(--space-4)';
          retakeBtn.onclick = () => this.retakePhoto();
          cameraSection.appendChild(retakeBtn);
          
        } catch (error) {
          console.error('Capture error:', error);
          this.showError('Failed to capture photo. Please try again.');
        }
      }
      
      retakePhoto() {
        // Clear previous capture
        this.faceData = null;
        document.getElementById('step3Next').disabled = true;
        
        // Remove preview
        const preview = document.querySelector('.camera-section img');
        if (preview) preview.remove();
        
        // Restart camera
        this.startCamera();
      }
      
      async testBackendConnection() {
        try {
          const response = await fetch('http://localhost:3000/api/health', {
            method: 'GET',
            timeout: 5000
          });
          return response.ok;
        } catch (error) {
          console.warn('Backend connection test failed:', error);
          return false;
        }
      }

      async handleStep3Next() {
        const button = document.getElementById('step3Next');
        
        if (!this.faceData) {
          this.showError('Please capture a face photo before continuing');
          return;
        }
        
        button.innerHTML = '<span class="loading-spinner"></span> Creating Account...';
        button.disabled = true;
        
        try {
          // Check if Firebase user was created
          if (!this.firebaseUser) {
            // If phone OTP was skipped, create user with email/password
            console.log('📧 Creating Firebase user with email/password');
            const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            const userCredential = await createUserWithEmailAndPassword(
              window.firebaseAuth,
              this.registrationData.email,
              this.registrationData.password
            );
            this.firebaseUser = userCredential.user;
          }
          
          console.log('✅ Firebase user:', this.firebaseUser.uid);
          
          // Save user profile and face data to Firestore
          const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          
          const userProfile = {
            uid: this.firebaseUser.uid,
            email: this.registrationData.email,
            firstName: this.registrationData.firstName,
            lastName: this.registrationData.lastName,
            username: this.registrationData.username,
            mobile: this.registrationData.mobile,
            faceDescriptor: this.faceData, // Store face descriptor array
            createdAt: new Date().toISOString(),
            authMethod: this.confirmationResult?.isTestPhone ? 'test-phone' : 
                       this.confirmationResult ? 'phone' : 'email'
          };
          
          await setDoc(doc(window.firebaseDb, 'users', this.firebaseUser.uid), userProfile);
          console.log('✅ User profile saved to Firestore');
          
          // Generate JWT token for backend API
          const idToken = await this.firebaseUser.getIdToken();
          localStorage.setItem('authToken', idToken);
          localStorage.setItem('userId', this.firebaseUser.uid);
          localStorage.setItem('userEmail', this.registrationData.email);
          
          this.showSuccess('✅ Account created successfully! Redirecting to dashboard...');
          
          setTimeout(() => {
            window.location.href = 'dashboard-enhanced.html';
          }, 2000);
          
        } catch (error) {
          console.error('❌ Registration error:', error);
          
          // Provide specific error messages
          let errorMessage = 'Registration failed. Please try again.';
          
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'Email already registered. Please login instead.';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password is too weak. Please use a stronger password.';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address format.';
          } else if (error.message) {
            errorMessage = error.message;
          }
          
          this.showError(errorMessage);
          button.innerHTML = 'Complete Registration';
          button.disabled = false;
        }
      }
      
      async registerInDemoMode(userData) {
        try {
          // Store user data locally for demo
          const demoUser = {
            ...userData,
            id: Date.now(),
            registered: new Date().toISOString(),
            mode: 'demo'
          };
          
          localStorage.setItem('demoUser', JSON.stringify(demoUser));
          localStorage.setItem('authToken', 'demo_token_' + Date.now());
          localStorage.setItem('userSession', JSON.stringify({
            username: userData.username,
            email: userData.email,
            loginTime: new Date().toISOString(),
            mode: 'demo'
          }));
          
          this.showSuccess('Account created successfully (Demo Mode)! Redirecting to dashboard...');
          return true;
        } catch (error) {
          console.error('Demo registration failed:', error);
          this.showError('Registration failed. Please try again.');
          return false;
        }
      }
      
      goToStep(step) {
        // Hide all steps
        for (let i = 1; i <= this.maxSteps; i++) {
          document.getElementById(`step${i}`).style.display = 'none';
        }
        
        // Show target step
        document.getElementById(`step${step}`).style.display = 'block';
        this.currentStep = step;
        
        // Update progress bar
        const progress = (step / this.maxSteps) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        
        // Clear messages
        this.hideMessages();
        
        console.log(`📋 Moved to step ${step}`);
      }
      
      async resendOTP() {
        const link = document.getElementById('resendOTP');
        const originalText = link.textContent;
        
        link.textContent = 'Sending...';
        link.style.pointerEvents = 'none';
        
        try {
          // Remove old OTP display
          const oldDisplay = document.getElementById('demo-otp-display');
          if (oldDisplay) {
            oldDisplay.remove();
          }
          
          // Generate new OTP and resend
          await this.sendOTP();
          
        } catch (error) {
          this.showError('Failed to resend code. Please try again.');
        } finally {
          link.textContent = originalText;
          link.style.pointerEvents = 'auto';
        }
      }
      
      showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        // Hide success message
        document.getElementById('successMessage').style.display = 'none';
        
        // Auto-hide after 5 seconds
        setTimeout(() => this.hideMessages(), 5000);
      }
      
      showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        
        // Hide error message
        document.getElementById('errorMessage').style.display = 'none';
      }
      
      hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
      }
      
      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }

    // Theme Management
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.classList.add(savedTheme);
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      
      // Initialize registration system
      try {
        new RegistrationManager();
        console.log('✅ Registration system loaded successfully');
      } catch (error) {
        console.error('❌ Registration system failed to initialize:', error);
        document.getElementById('errorMessage').textContent = 'System initialization failed. Please refresh the page.';
        document.getElementById('errorMessage').style.display = 'block';
      }
    });
  </script>
</body>
</html>