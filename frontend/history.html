<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>History - Mini Task Scheduler</title>
  <link rel="stylesheet" href="styles-enhanced.css">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  
  <!-- Mobile optimizations -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Task Scheduler">
  <link rel="apple-touch-icon" href="./assets/logo.png">
  
  <!-- Theme colors -->
  <meta name="theme-color" content="#2563eb">
  <meta name="msapplication-TileColor" content="#2563eb">
  <style>
    .history-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 2rem 2.5rem 1rem 2.5rem;
      margin-bottom: 1rem;
      background: var(--card-bg);
      border-radius: 16px;
      margin: 1rem 2.5rem;
      box-shadow: 0 2px 12px rgba(37,99,235,0.06);
    }
    .history-stats {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.2rem; 
      margin: 0 2.5rem 1.5rem 2.5rem;
    }
    .stat-card {
      background: var(--card-bg); 
      padding: 1.3rem; 
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(37,99,235,0.08); 
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(37,99,235,0.15);
    }
    .stat-number {
      font-size: 2.2rem; 
      font-weight: 800; 
      margin: 0.4rem 0;
      background: linear-gradient(90deg, #2563eb, #10b981);
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .history-main {
      display: grid; 
      grid-template-columns: 1.8fr 1fr; 
      gap: 1.8rem;
      margin: 0 2.5rem; 
      align-items: flex-start;
    }
    .history-filters {
      display: flex; 
      gap: 0.8rem; 
      margin-bottom: 1.5rem; 
      flex-wrap: wrap;
      justify-content: center;
    }
    .filter-btn {
      padding: 0.6rem 1.2rem; 
      border-radius: 24px; 
      border: none;
      background: rgba(37,99,235,0.08); 
      color: var(--accent);
      cursor: pointer; 
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .filter-btn:hover {
      background: rgba(37,99,235,0.15);
      transform: translateY(-1px);
    }
    .filter-btn.active {
      background: var(--accent); 
      color: white;
      box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    }
    .history-item {
      background: var(--card-bg); border-radius: 12px; padding: 1.2rem;
      margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(37,99,235,0.06);
      transition: all 0.2s; position: relative;
    }
    .history-item:hover {
      transform: translateY(-2px); box-shadow: 0 4px 16px rgba(37,99,235,0.12);
    }
    .history-item.completed {
      border-left: 4px solid #10b981;
    }
    .history-item.failed {
      border-left: 4px solid #ef4444;
    }
    .history-task-title {
      font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .history-details {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.8rem; font-size: 0.9rem; color: var(--muted);
    }
    .time-chart {
      background: var(--card-bg); 
      border-radius: 16px; 
      padding: 1.5rem;
      box-shadow: 0 4px 16px rgba(37,99,235,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .time-chart:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(37,99,235,0.15);
    }
    .time-chart h4 {
      margin: 0 0 1rem 0;
      color: var(--text);
      font-weight: 700;
    }
    .productivity-chart {
      height: 180px; 
      background: linear-gradient(180deg, rgba(37,99,235,0.08) 0%, transparent 100%);
      border-radius: 12px; 
      margin-top: 1rem; 
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed rgba(37,99,235,0.2);
    }
    @media (max-width: 900px) {
      .history-main { 
        grid-template-columns: 1fr; 
        gap: 1.5rem;
        margin: 0 1rem;
      }
      .history-header { 
        margin: 1rem;
        padding: 1.5rem;
        flex-direction: column;
        gap: 1.2rem;
        text-align: center;
      }
      .history-stats { 
        margin: 0 1rem 1.5rem 1rem;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
      }
      .stat-card {
        padding: 1rem;
      }
      .stat-number {
        font-size: 1.8rem;
      }
      
      /* Better button layout on mobile */
      .history-header > div:last-child {
        display: flex;
        gap: 0.8rem;
        justify-content: center;
        flex-wrap: wrap;
      }
    }
    
    /* Mobile portrait */
    @media (max-width: 768px) {
      .history-filters {
        justify-content: flex-start;
        gap: 0.5rem;
        margin-bottom: 1.2rem;
      }
      
      .filter-btn {
        padding: 0.7rem 1rem;
        font-size: 0.85rem;
        min-height: 44px;
        touch-action: manipulation;
      }
      
      .history-details {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .history-item {
        padding: 1rem;
        margin-bottom: 0.8rem;
      }
      
      .export-btn, .import-btn {
        padding: 0.8rem 1rem;
        font-size: 0.85rem;
        min-height: 44px;
        touch-action: manipulation;
        flex: 1;
      }
      
      h1 {
        font-size: 1.8rem !important;
      }
      
      .time-chart {
        padding: 1rem;
      }
      
      .stat-card {
        padding: 0.8rem;
      }
      
      .stat-number {
        font-size: 1.5rem;
        margin: 0.2rem 0;
      }
    }
    
    /* Landscape orientation fixes */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      .history-header {
        padding: 0.8rem;
        margin: 0.5rem 1rem;
        flex-direction: row;
        gap: 1rem;
        text-align: left;
      }
      
      .history-header h1 {
        font-size: 1.4rem !important;
        margin: 0 !important;
      }
      
      .history-header p {
        font-size: 0.8rem !important;
        margin: 0.2rem 0 0 0 !important;
      }
      
      .history-stats {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.6rem;
        margin: 0 1rem 1rem 1rem;
      }
      
      .stat-card {
        padding: 0.6rem;
      }
      
      .stat-number {
        font-size: 1.2rem;
        margin: 0.1rem 0;
      }
      
      .stat-card div:first-child {
        font-size: 0.75rem;
      }
      
      .time-chart {
        padding: 0.8rem;
      }
      
      .history-main {
        gap: 1rem;
      }
      
      .filter-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }
    
    /* Tooltip Styles */
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      white-space: nowrap;
      z-index: 1000;
      animation: tooltipFadeIn 0.2s ease;
      max-width: 250px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
    }
    
    .tooltip:hover::before {
      content: '';
      position: absolute;
      bottom: 92%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
    }
    
    @keyframes tooltipFadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>
  <nav class="topnav">
    <div class="brand"><img src="./assets/logo.png" alt="logo" class="nav-logo"> <span>Mini Task Scheduler</span></div>
    <div class="navlinks">
      <a href="dashboard-enhanced.html">üìÖ Dashboard</a>
      <a href="history.html" class="active">üìú Task History</a>
      <a href="about.html">‚ÑπÔ∏è About</a>
      <button id="theme-toggle">üåô</button>
    </div>
  </nav>

  <div class="history-header">
    <div>
      <h1 class="history-title">Task History</h1>
      <p class="history-subtitle">Track your productivity and completed tasks</p>
    </div>
    <div class="history-stats-container">
      <button onclick="exportHistory()" class="filter-btn">üì• Export</button>
      <button onclick="clearHistory()" class="filter-btn">üóëÔ∏è Clear All</button>
    </div>
  </div>

  <div class="history-stats">
    <div class="stat-card tooltip" data-tooltip="Total number of tasks you have successfully completed">
      <div class="history-stat-label">Total Completed</div>
      <div class="stat-number" id="totalCompleted">0</div>
    </div>
    <div class="stat-card tooltip" data-tooltip="Tasks completed in the last 7 days from today">
      <div class="history-stat-label">This Week</div>
      <div class="stat-number" id="weekCompleted">0</div>
    </div>
    <div class="stat-card tooltip" data-tooltip="Percentage of completed tasks vs total tasks created (Completed √∑ Total √ó 100)">
      <div class="history-stat-label">Success Rate</div>
      <div class="stat-number" id="successRate">0%</div>
    </div>
    <div class="stat-card tooltip" data-tooltip="Average tasks completed per day (Total completed √∑ days since first task)">
      <div class="history-stat-label">Avg. per Day</div>
      <div class="stat-number" id="avgPerDay">0</div>
    </div>
  </div>

  <main class="history-main">
    <section>
      <div class="card">
        <h3>üìã Completed Tasks</h3>
        <div class="history-filters">
          <button class="filter-btn active" onclick="filterHistory('all')">All</button>
          <button class="filter-btn" onclick="filterHistory('today')">Today</button>
          <button class="filter-btn" onclick="filterHistory('week')">This Week</button>
          <button class="filter-btn" onclick="filterHistory('month')">This Month</button>
        </div>
        <div id="historyList">
          <div class="history-empty-state">
            No completed tasks yet. Complete some tasks to see history!
          </div>
        </div>
      </div>
    </section>
    
    <section>
      <div class="time-chart">
        <h4>üìä Productivity Chart</h4>
        <div class="productivity-chart" id="productivityChart">
          <div class="history-loading">
            Complete tasks to see chart
          </div>
        </div>
      </div>
      
      <div class="card history-insights-card">
        <h4>üéØ Quick Stats</h4>
        <div class="history-insights-list">
                    <div class="history-insight-item" class="tooltip" data-tooltip="Hour of day (0-23) when you complete the most tasks">
            <span><strong>Most Productive Hour:</strong></span>
            <span id="mostProductiveHour">2:00 PM</span>
          </div>
          <div class="history-insight-item" class="tooltip" data-tooltip="The mood you select most often when creating tasks">
            <span><strong>Favorite Mood:</strong></span>
            <span id="favoriteMood">üòä Happy</span>
          </div>
          <div class="history-insight-item" class="tooltip" data-tooltip="Estimated longest consecutive days of productivity (completed tasks √∑ 7)">
            <span><strong>Longest Streak:</strong></span>
            <span id="longestStreak">7 days</span>
          </div>
          <div class="history-insight-item" class="tooltip" data-tooltip="Estimated time saved through better organization (completed tasks √ó 0.5 hours)">
        </div>
      </div>
    </section>
  </main>

  <script src="auth.js"></script>
  <script src="theme.js"></script>
  <script src="header.js"></script>
  <script src="script.js"></script>
  <script src="auth-backend.js"></script>
  <!-- Load API Configuration -->
  <script src="api-config.js"></script>
  
  <script>
    // History page with backend integration
    let apiConfig = null;
    let currentFilter = 'all';
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize API configuration
      apiConfig = new APIConfig();
      
      loadHistory();
      updateHistoryStats();
    });
    
    // Load history from backend
    async function loadHistory() {
      let completedTasks = [];
      
      try {
        // Try to get history from backend
        const response = await fetch(apiConfig.getDataEndpoint('/history'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          completedTasks = await response.json();
          console.log('üì• History loaded from backend:', completedTasks.length);
        } else {
          throw new Error('Backend history not available');
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Backend history failed, using localStorage');
        
        // Fallback to localStorage
        const localHistory = JSON.parse(localStorage.getItem('taskHistory') || '[]');
        const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        const localCompleted = tasks.filter(task => task.status === 'completed');
        
        completedTasks = [...localHistory, ...localCompleted];
      }
      
      const historyList = document.getElementById('historyList');
      
      if (completedTasks.length === 0) {
        historyList.innerHTML = `
          <div class="history-empty-state">
            No completed tasks yet. Complete some tasks to see history!
          </div>
        `;
        return;
      }
      
      const filteredTasks = filterTasksByPeriod(completedTasks, currentFilter);
      
      historyList.innerHTML = filteredTasks.map(task => `
        <div class="history-item completed">
          <div class="history-task-title">
            <span>${getMoodEmoji(task.mood)}</span>
            <span>${task.command}</span>
            <span class="task-completed-status">‚úÖ Completed</span>
          </div>
          <div class="history-details">
            <div><strong>Time:</strong> ${formatTime(task.time)}</div>
            <div><strong>Priority:</strong> ${task.priority}</div>
            <div><strong>Completed:</strong> ${formatDate(task.completedAt)}</div>
            <div><strong>Mood:</strong> ${task.mood}</div>
          </div>
        </div>
      `).join('');
    }
    
    function filterTasksByPeriod(tasks, period) {
      const now = new Date();
      return tasks.filter(task => {
        const completedDate = new Date(task.completedAt);
        switch(period) {
          case 'today':
            return completedDate.toDateString() === now.toDateString();
          case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return completedDate >= weekAgo;
          case 'month':
            return completedDate.getMonth() === now.getMonth() && 
                   completedDate.getFullYear() === now.getFullYear();
          default:
            return true;
        }
      });
    }
    
    function filterHistory(period) {
      currentFilter = period;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadHistory();
    }
    
    function updateHistoryStats() {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      const completedTasks = tasks.filter(task => task.status === 'completed');
      const totalTasks = tasks.length;
      
      // Update stat cards
      document.getElementById('totalCompleted').textContent = completedTasks.length;
      
      const weekCompleted = filterTasksByPeriod(completedTasks, 'week').length;
      document.getElementById('weekCompleted').textContent = weekCompleted;
      
      const successRate = totalTasks > 0 ? Math.round((completedTasks.length / totalTasks) * 100) : 0;
      document.getElementById('successRate').textContent = successRate + '%';
      
      const avgPerDay = completedTasks.length > 0 ? 
        Math.round((completedTasks.length / Math.max(1, getTaskSpanDays(completedTasks))) * 10) / 10 : 0;
      document.getElementById('avgPerDay').textContent = avgPerDay;
      
      // Update quick stats
      updateQuickStats(completedTasks);
    }
    
    function updateQuickStats(completedTasks) {
      if (completedTasks.length === 0) return;
      
      // Most productive hour
      const hourCounts = {};
      completedTasks.forEach(task => {
        const hour = parseInt(task.time.split(':')[0]);
        hourCounts[hour] = (hourCounts[hour] || 0) + 1;
      });
      const mostProductiveHour = Object.keys(hourCounts).reduce((a, b) => 
        hourCounts[a] > hourCounts[b] ? a : b
      );
      document.getElementById('mostProductiveHour').textContent = 
        mostProductiveHour + ':00 (' + hourCounts[mostProductiveHour] + ' tasks)';
      
      // Favorite mood
      const moodCounts = {};
      completedTasks.forEach(task => {
        moodCounts[task.mood] = (moodCounts[task.mood] || 0) + 1;
      });
      const favoriteMood = Object.keys(moodCounts).reduce((a, b) => 
        moodCounts[a] > moodCounts[b] ? a : b
      );
      document.getElementById('favoriteMood').textContent = 
        getMoodEmoji(favoriteMood) + ' ' + favoriteMood + ' (' + moodCounts[favoriteMood] + ')';
      
      // Longest streak and time saved (simplified calculations)
      document.getElementById('longestStreak').textContent = 
        Math.max(1, Math.floor(completedTasks.length / 7)) + ' days';
      document.getElementById('timeSaved').textContent = 
        Math.round(completedTasks.length * 0.5) + ' hours';
    }
    
    function getTaskSpanDays(tasks) {
      if (tasks.length === 0) return 1;
      const dates = tasks.map(task => new Date(task.completedAt).getTime());
      const minDate = Math.min(...dates);
      const maxDate = Math.max(...dates);
      return Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)));
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function exportHistory() {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      const completedTasks = tasks.filter(task => task.status === 'completed');
      
      const csvContent = "data:text/csv;charset=utf-8," 
        + "Task,Priority,Mood,Completed Time,Execution Time\n"
        + completedTasks.map(task => 
          `"${task.command}","${task.priority}","${task.mood}","${formatDate(task.completedAt)}","${task.time}"`
        ).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "task_history.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('History exported successfully!', 'success');
    }
    
    function clearHistory() {
      if (confirm('Are you sure you want to clear all task history? This cannot be undone.')) {
        let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
        tasks = tasks.filter(task => task.status !== 'completed');
        localStorage.setItem('tasks', JSON.stringify(tasks));
        loadHistory();
        updateHistoryStats();
        showToast('History cleared', 'info');
      }
    }
    
    function getMoodEmoji(mood) {
      const moods = {
        excited: 'üòÉ',
        neutral: 'üòê',
        dreading: 'üò´',
        challenging: 'üí°',
        routine: 'üîÅ'
      };
      return moods[mood] || 'üòê';
    }
    
    function formatTime(time) {
      return new Date(`2000-01-01T${time}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    // Toast function for history page
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: var(--card-bg); color: var(--text); padding: 1rem 1.5rem;
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-left: 4px solid ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#2563eb'};
        animation: slideIn 0.3s ease;
      `;
      
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
